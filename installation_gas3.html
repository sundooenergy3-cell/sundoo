<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>전화상담도우미</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" />
  <link rel="stylesheet" href="css/installation_gas3.css" />

  <!-- ✅ 공용 기록 JS -->
  <script src="js/app.js" defer></script>
</head>

<body>
  <main class="page">
    <!-- 선택 기록 패널 -->
    <aside class="history" aria-label="선택 기록">
      <div class="history-head">
        <h2 class="history-title">선택 기록</h2>
        <button type="button" class="history-clear">지우기</button>
      </div>

      <ul class="history-list"></ul>
      <p class="history-hint">이전 단계 선택이 저장됩니다.</p>
    </aside>

    <!-- 기존 화면 -->
    <div class="container">
      <header class="logo-area">
        <a href="index.html">
          <img src="img/logo.png" alt="SUNDOO" class="logo" />
        </a>
      </header>

      <main class="content">
        <!-- 금액 -->
        <h1 class="title" id="price">+0원</h1>

        <div class="subtitle-row">
          <p class="subtitle">배관이 나갈 구멍 유/무를 확인해주세요.</p>
          <button type="button" class="prev-btn" id="prevBtn">이전으로</button>
        </div>

        <div class="button-wrap">
          <button class="type-btn active" data-hole="yes">있음</button>
          <button class="type-btn" data-hole="no">없음</button>
        </div>
      </main>
    </div>
  </main>

  <script>
    const priceEl = document.getElementById("price");
    const buttons = document.querySelectorAll(".type-btn");
    const prevBtn = document.getElementById("prevBtn");

    const PRICE_KEY = "install_price";
    const HOLE_KEY = "hole_yn";
    const HISTORY_KEY = "sundoo_selection_history";

    // ✅ gas3 진입 시점의 "선택 전 금액(base)" 저장 키
    const BASE_BEFORE_KEY = "install_price_before_hole";

    const ADD_PRICE_NO_HOLE = 55000;

    function toNum(v) {
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }

    function getPrice() {
      return Math.max(0, toNum(localStorage.getItem(PRICE_KEY)));
    }

    function setPrice(newPrice) {
      const v = Math.max(0, toNum(newPrice));
      localStorage.setItem(PRICE_KEY, String(v));
      priceEl.textContent = `+${v.toLocaleString()}원`;
    }

    function pushHistory(label, url) {
      try {
        const arr = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
        const list = Array.isArray(arr) ? arr : [];
        list.push({ label, url, ts: Date.now() });
        localStorage.setItem(HISTORY_KEY, JSON.stringify(list.slice(-30)));
      } catch {}
    }

    /**
     * ✅ 핵심: gas3에 들어올 때 상태 정리
     * - 이전에 "없음"을 눌렀던 상태가 남아있으면(가격 +55,000 포함)
     *   -> base로 복원하고, 선택도 초기화해서 "있음(+0)"이 정상 동작하게 함
     */
    (function init() {
      const current = getPrice();
      const savedBase = localStorage.getItem(BASE_BEFORE_KEY);

      // base가 없으면 현재 가격을 base로 저장
      if (savedBase === null) {
        localStorage.setItem(BASE_BEFORE_KEY, String(current));
      }

      // base 재계산(혹시 current가 이미 +55,000 포함이면 빼서 base 잡기)
      let base = Math.max(0, toNum(localStorage.getItem(BASE_BEFORE_KEY)));

      const holeSaved = localStorage.getItem(HOLE_KEY); // "yes" or "no" or null

      // 이전에 "no"가 저장돼 있고, 현재 금액이 base+55000이면 base를 복원
      if (holeSaved === "no") {
        // base가 0이거나 꼬였을 수도 있으니, current - 55000이 더 그럴듯하면 그걸 base로 사용
        const inferredBase = Math.max(0, current - ADD_PRICE_NO_HOLE);
        if (inferredBase > 0) base = inferredBase;

        localStorage.setItem(BASE_BEFORE_KEY, String(base));
        localStorage.setItem(PRICE_KEY, String(base));   // ✅ 가격을 base로 복원
        localStorage.removeItem(HOLE_KEY);               // ✅ 선택 초기화
      }

      // 초기 표시: base로 보여주기
      setPrice(base);

      // 버튼 active 상태 초기화(선택 초기 상태: yes)
      buttons.forEach((b) => b.classList.remove("active"));
      const yesBtn = document.querySelector('.type-btn[data-hole="yes"]');
      if (yesBtn) yesBtn.classList.add("active");
    })();

    // ✅ 클릭 시에는 "그 순간의 base"를 다시 읽어서 계산 (상수 basePrice 사용 X)
    buttons.forEach((btn) => {
      btn.addEventListener("click", () => {
        buttons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");

        const hole = btn.dataset.hole; // yes / no
        localStorage.setItem(HOLE_KEY, hole);

        const base = Math.max(0, toNum(localStorage.getItem(BASE_BEFORE_KEY)));
        const nextPrice = hole === "no" ? (base + ADD_PRICE_NO_HOLE) : base;

        setPrice(nextPrice);

        const nextUrl = "installation_gas4.html";
        pushHistory(`배관 구멍: ${hole === "yes" ? "있음(+0)" : "없음(+55,000)"}`, nextUrl);

        location.href = nextUrl;
      });
    });

    // ✅ 이전으로: gas2로 이동 (선택 자체를 취소)
    prevBtn.addEventListener("click", (e) => {
      e.preventDefault();

      const base = Math.max(0, toNum(localStorage.getItem(BASE_BEFORE_KEY)));
      localStorage.setItem(PRICE_KEY, String(base));
      localStorage.removeItem(HOLE_KEY);
      localStorage.removeItem(BASE_BEFORE_KEY);

      location.href = "installation_gas2.html";
    });
  </script>
</body>
</html>
