<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>전화상담도우미 - 건조기</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" />
  <link rel="stylesheet" href="css/installation_gas3.css" />

  <script src="js/app.js" defer></script>
</head>

<body>
  <main class="page">
    <aside class="history" aria-label="선택 기록">
      <div class="history-head">
        <h2 class="history-title">선택 기록</h2>
        <button type="button" class="history-clear">지우기</button>
      </div>

      <ul class="history-list"></ul>
      <p class="history-hint">이전 단계 선택이 저장됩니다.</p>
    </aside>

    <div class="container">
      <header class="logo-area">
        <a href="mobile.html">
          <img src="img/logo.png" alt="SUNDOO" class="logo" />
        </a>
      </header>

      <main class="content">
        <h1 class="title" id="price">+0원</h1>

        <div class="subtitle-row">
          <p class="subtitle">배관이 나갈 구멍 유/무를 확인해주세요.</p>
          <button type="button" class="prev-btn" id="prevBtn">이전으로</button>
        </div>

        <div class="button-wrap">
          <button class="type-btn" data-hole="yes">있음</button>
          <button class="type-btn" data-hole="no">없음</button>
        </div>
      </main>
    </div>
  </main>

  <script>
    const priceEl = document.getElementById("price");
    const buttons = document.querySelectorAll(".type-btn");
    const prevBtn = document.getElementById("prevBtn");

    const PRICE_KEY = "install_price";
    const HISTORY_KEY = "sundoo_selection_history";

    const PRODUCT_EXTRA_KEY = "dryer_product_extra";
    const HOLE_EXTRA_KEY = "dryer_hole_extra";
    const CHIMNEY_EXTRA_KEY = "dryer_chimney_extra";

    const ADD_PRICE_NO_HOLE = 55000;

    function toNum(v) {
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }

    function renderPrice(v) {
      priceEl.textContent = `+${Math.max(0, v).toLocaleString()}원`;
    }

    function calcTotal() {
      const product = toNum(localStorage.getItem(PRODUCT_EXTRA_KEY));
      const hole = toNum(localStorage.getItem(HOLE_EXTRA_KEY));
      const chimney = toNum(localStorage.getItem(CHIMNEY_EXTRA_KEY));
      return Math.max(0, product + hole + chimney);
    }

    function setTotal(v) {
      const n = Math.max(0, toNum(v));
      localStorage.setItem(PRICE_KEY, String(n));
      renderPrice(n);
    }

    function pushHistory(label, url) {
      try {
        const arr = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
        arr.push({ label, url, ts: Date.now() });
        localStorage.setItem(HISTORY_KEY, JSON.stringify(arr.slice(-30)));
      } catch {}
    }

    /* ✅ 핵심: 이 페이지 들어오면
       - 이 페이지에서 더해졌던(hole_extra) 금액이 있으면 빼서 base로 복원
       - hole 선택/extra를 초기화(=미선택 상태)
    */
    let base = 0;

    (function init() {
      const currentTotal = calcTotal();
      const prevExtra = toNum(localStorage.getItem(HOLE_EXTRA_KEY)); // 0 or 55000

      base = Math.max(0, currentTotal - prevExtra);

      // 미선택 상태로 초기화
      localStorage.removeItem("hole_yn");
      localStorage.removeItem("dryer_hole_yn");
      localStorage.setItem(HOLE_EXTRA_KEY, "0");

      buttons.forEach((b) => b.classList.remove("active"));

      // 화면/저장 금액은 base
      setTotal(base);
    })();

    buttons.forEach((btn) => {
      btn.addEventListener("click", () => {
        buttons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");

        const hole = btn.dataset.hole; // yes / no
        const extra = (hole === "no") ? ADD_PRICE_NO_HOLE : 0;

        // ✅ 최종요약이 읽는 키로 저장
        localStorage.setItem("hole_yn", hole);
        localStorage.setItem("dryer_hole_yn", hole);

        localStorage.setItem(HOLE_EXTRA_KEY, String(extra));

        const total = base + extra;
        setTotal(total);

        const nextUrl = "installation_dryer4.html";
        pushHistory(
          `배관 구멍: ${hole === "yes" ? "있음(+0원)" : "없음(+55,000원)"}`,
          nextUrl
        );

        location.href = nextUrl;
      });
    });

    prevBtn.addEventListener("click", (e) => {
      e.preventDefault();
      // 이전으로는 “선택 전(base)” 금액이어야 함
      setTotal(base);
      location.href = "installation_dryer2.html";
    });
  </script>
</body>
</html>
